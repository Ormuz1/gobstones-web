<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../scripts/simplemde.html">
<link rel="import" href="../../scripts/stylist.html">
<link rel="import" href="../../scripts/loaders/components/metadataLoader.html">
<link rel="import" href="../../scripts/behaviors/busListenerBehavior.html">
<link rel="import" href="../../scripts/behaviors/permissionsBehavior.html">
<link rel="import" href="../../scripts/behaviors/localizationBehavior.html">
<link rel="import" href="../../scripts/behaviors/loaderBehavior.html">

<dom-module id="metadata-editor">
  <template>
    <style>
      .menu-header-gobstones {
        background-color: white;
        font-weight: 800;
      }

      .metadata-editor-options {
        width: 100%;
        overflow: scroll;
        overflow-x: hidden;
      }

      .json-editor {
        height: 50vh;
      }

      .gray {
        color: gray;
      }

      .option-enabled {
        color: green;
      }

      .option-disabled {
        color: red;
      }
    </style>

    <div class="metadata-editor-options">
      <paper-item center-justified flex>
        <paper-item-body>
          <paper-toggle-button checked="{{advancedMode}}">Modo avanzado</paper-toggle-button>
        </paper-item-body>
      </paper-item>

      <template is="dom-if" if="[[advancedMode]]">
        <paper-item center-justified flex class="menu-header-gobstones">
          <div>[[localize("settings-code")]]</div>
        </paper-item>

        <paper-item>
          <paper-item-body>
            <div>[[localize("settings-code-visible")]]</div>
          </paper-item-body>
          <paper-toggle-button checked="{{metadata.source.visible}}"></paper-toggle-button>
        </paper-item>

        <paper-item>
          <paper-item-body>
            <div>[[localize("settings-code-autoopen-description")]]</div>
          </paper-item-body>
          <paper-toggle-button checked="{{metadata.initialDescription}}"></paper-toggle-button>
        </paper-item>

        <paper-item>
          <paper-item-body>
            <div>[[localize("settings-code-link")]]</div>
          </paper-item-body>
          <paper-input value="{{metadata.link}}"></paper-input>
        </paper-item>

        <paper-item center-justified flex class="menu-header-gobstones">
          <div>[[localize("settings-boards")]]</div>
        </paper-item>

        <paper-item>
          <paper-item-body>
            <div>[[localize("settings-boards-visible-edition")]]</div>
          </paper-item-body>
          <paper-toggle-button on-tap="_onBoardVisibleEditionChanged" checked="{{metadata.board.visible_edition}}"></paper-toggle-button>
        </paper-item>

        <paper-item disabled$="{{boardEditionOptionsDisabled}}">
          <paper-item-body>
            <div>[[localize("settings-boards-collapse-toolbox")]]</div>
          </paper-item-body>
          <paper-toggle-button checked="{{metadata.board.collapse_toolbox}}"></paper-toggle-button>
        </paper-item>

        <paper-item disabled$="{{boardEditionOptionsDisabled}}">
          <paper-item-body>
            <div>[[localize("settings-boards-can-change-initial-board")]]</div>
          </paper-item-body>
          <paper-toggle-button checked="{{metadata.board.user_permissions.can_change_initial_board}}"></paper-toggle-button>
        </paper-item>

        <paper-item disabled$="{{boardEditionOptionsDisabled}}">
          <paper-item-body>
            <div>[[localize("settings-boards-can-view-size-section")]]</div>
          </paper-item-body>
          <paper-toggle-button checked="{{metadata.board.user_permissions.can_view_size_section}}"></paper-toggle-button>
        </paper-item>

        <paper-item>
          <paper-item-body>
            <div>[[localize("settings-boards-can-edit-board")]]</div>
          </paper-item-body>
          <paper-toggle-button checked="{{metadata.board.user_permissions.can_edit_board}}"></paper-toggle-button>
        </paper-item>

        <paper-item center-justified flex class="menu-header-gobstones">
          <div>[[localize("settings-attires")]]</div>
        </paper-item>

        <paper-item>
          <paper-item-body>
            <div>[[localize("settings-attires-visible")]]</div>
          </paper-item-body>
          <paper-toggle-button checked="{{metadata.attire.visible}}"></paper-toggle-button>
        </paper-item>

        <paper-item disabled$="{{boardEditionOptionsDisabled}}">
          <paper-item-body>
            <div>[[localize("settings-boards-can-view-attire-section")]]</div>
          </paper-item-body>
          <paper-toggle-button on-tap="_onAttireSectionVisibleChanged" checked="{{metadata.board.user_permissions.can_view_attire_section}}"></paper-toggle-button>
        </paper-item>

        <paper-item disabled$="[[_either(boardEditionOptionsDisabled, attireSectionDisabled)]]">
          <paper-item-body>
            <div>[[localize("settings-attires-can-toggle-visibility")]]</div>
          </paper-item-body>
          <paper-toggle-button checked="{{metadata.attire.user_permissions.can_toggle_visibility}}"></paper-toggle-button>
        </paper-item>

        <paper-item center-justified flex class="menu-header-gobstones">
          <div>[[localize("settings-execution")]]</div>
        </paper-item>

        <paper-item>
          <paper-item-body>
            <div>[[localize("settings-boards-can-change-initial-board-source")]]</div>
          </paper-item-body>
          <paper-toggle-button checked="{{metadata.board.user_permissions.can_change_initial_board_source}}"></paper-toggle-button>
        </paper-item>

        <paper-item>
          <paper-item-body>
            <div>[[localize("settings-execution-speed-can-change-speed")]]</div>
          </paper-item-body>
          <paper-toggle-button checked="{{metadata.execution_speed.user_permissions.can_change_speed}}"></paper-toggle-button>
        </paper-item>

        <paper-item center-justified flex class="menu-header-gobstones">
          <div>[[localize("settings-blocks")]]</div>
        </paper-item>

        <!-- Al pasarlo entre corchetes dobles, la expresión se vuelve a evaluar cuando cambia la metadata -->
        <blocks-toolbox-selector default-toolbox="{{defaultToolbox}}" blocks="[[metadata.blocks]]"></blocks-toolbox-selector>
      </template>

      <template is="dom-if" if="[[!advancedMode]]">
        <paper-item>
          <paper-item-body three-line>
            <div>Tipo de actividad</div>
            <div secondary>Define qué elementos del panel de tableros están visibles y pueden utilizarse.</div>
          </paper-item-body>
          <paper-dropdown-menu>
            <paper-listbox class="dropdown-content" selected="{{selectedSolution}}">
              <paper-item>Con dominio</paper-item>
              <paper-item>Sin dominio</paper-item>
              <paper-item>De representación</paper-item>
              <paper-item>Libre</paper-item>
              <paper-item>Personalizada</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>
        </paper-item>

        <paper-item>
          <paper-item-body three-line>
            <div>Herramientas disponibles</div>
            <div secondary>Esta opción limita qué bloques pueden utilizar tus estudiantes.</div>
          </paper-item-body>
          <paper-dropdown-menu>
            <paper-listbox class="dropdown-content" selected="{{selectedToolboxIndex}}">
              <template is="dom-repeat" items="{{ availableToolboxes }}">
                <paper-item>{{item.name}}</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
        </paper-item>

        <paper-item center-justified flex class="menu-header-gobstones">
          <div>Tablero</div>
        </paper-item>

        <paper-item>
          <paper-item-body>
            <div secondary>
              <iron-icon icon="icons:close" class="option-disabled"></iron-icon>
              <span>Editar el contenido</span>
            </div>
          </paper-item-body>
          <paper-item-body>
            <div secondary>
              <iron-icon icon="icons:close" class="option-disabled"></iron-icon>
              <span>Elegir el tablero inicial</span>
            </div>
          </paper-item-body>
        </paper-item>

        <paper-item center-justified flex class="menu-header-gobstones">
          <div>Vestimenta</div>
        </paper-item>

        <paper-item>
          <paper-item-body>
            <div secondary>
              <iron-icon icon="icons:check" class="option-enabled"></iron-icon>
              <span>Visible por defecto</span>
            </div>
          </paper-item-body>
          <paper-item-body>
            <div secondary>
              <iron-icon icon="icons:close" class="option-disabled"></iron-icon>
              <span>Decidir si está visible</span>
            </div>
          </paper-item-body>
          <paper-item-body>
            <div secondary>
              <iron-icon icon="icons:check" class="option-enabled"></iron-icon>
              <span>Cambiar entre vestimentas</span>
            </div>
          </paper-item-body>
        </paper-item>

        <paper-item center-justified flex class="menu-header-gobstones">
          <div>Caja de herramientas</div>
        </paper-item>

        <paper-item style="flex-wrap: wrap;">
          <template is="dom-repeat" items="{{allToolboxes}}">
            <paper-item-body style="margin-right: 10px; overflow: unset;">
              <div secondary>
                <template is="dom-if" if="[[ !isToolSelected(selectedToolbox, item) ]]">
                  <iron-icon icon="icons:close" class="option-disabled"></iron-icon>
                </template>
                <template is="dom-if" if="[[ isToolSelected(selectedToolbox, item) ]]">
                  <iron-icon icon="icons:check" class="option-enabled"></iron-icon>
                </template>
                {{item}}
              </div>
            </paper-item-body>
          </template>
        </paper-item>
      </template>
    </div>
  </template>

  <script>
    const inicial = {
      name: 'Inicial',
      features: ['Procedimientos simples'],
      blocks: [
        { type: 'procedures_defnoreturnnoparams' },
        { type: 'Procedimientos primitivos' },
        { type: 'Mis procedimientos' },
      ],
    };

    const media = {
      name: 'Media',
      features: [
        ...inicial.features,
        'Procedimientos con parámetros',
        'Expresiones y literales numéricos',
        'Expresiones booleanas',
        'Repetición simple',
        'Alternativa condicional',
        'Funciones simples',
      ],
      blocks: [
        ...inicial.blocks,
        { type: 'procedures_defnoreturn' },
        { type: 'math_number' },
        { type: 'OperadorNumerico' },
        { type: 'OperadorLogico' },
        { type: 'OperadorDeComparacion' },
        { type: 'not' },
        { type: 'RepeticionSimple' },
        { type: 'Alternativas' },
        { type: 'procedures_defreturnsimple' },
        { type: 'Mis funciones' },
        { type: 'Funciones primitivas' },
      ],
    };

    const avanzada = {
      name: 'Avanzada',
      features: [
        ...media.features,
        'Funciones con procesamiento',
        'Repetición condicional'
      ],
      blocks: [
        ...media.blocks,
        { type: 'procedures_defreturnsimplewithparams' },
        { type: 'procedures_defreturn' },
        { type: 'RepeticionCondicional' },
        { type: 'Asignación' },
        { type: 'BoolSelector' },
        { type: 'Alternativas' },
        { type: 'procedures_defreturnsimple' },
        { type: 'Mis funciones' },
        { type: 'Funciones primitivas' },
      ],
    };

    const sinDominio = {
      features: ['Comandos primitivos', 'Direcciones y colores'],
      blocks: [
        { type: 'Comandos primitivos' },
        { type: 'ColorSelector' },
        { type: 'DireccionSelector' },
        { type: 'Expresiones primitivas' },
      ],
    };

    Polymer({
      is: 'metadata-editor',
      properties: {
        metadata: {
          type: Object,
          value: { }
        },
        defaultToolbox: String,
        advancedMode: {
          type: Boolean,
          value: false
        },
        availableToolboxes: {
          type: Array,
          value: [inicial, media, avanzada]
        },
        selectedToolboxIndex: {
          type: Number,
          value: 0
        },
        selectedToolbox: {
          type: Object,
          computed: "_computeSelectedToolbox(selectedToolboxIndex)"
        },
        allToolboxes: {
          type: Array,
          value: [
            ...avanzada.features,
            ...sinDominio.features
          ]
        },
        previewChanges: {
          type: Boolean,
          value: false
        },
        boardEditionOptionsDisabled: {
          type: Boolean,
          value: false
        },
        attireSectionDisabled: {
          type: Boolean,
          value: false
        }
      },
      /* @faloi:
      Agregué este listener para que el blocks-toolbox-selector avise cuando cambian los
      bloques seleccionados.
      Ver https://polymer-library.polymer-project.org/1.0/docs/devguide/events#event-listeners
      */
      listeners: {
        'teacher-selected-blocks-changed': '_onSelectedBlocksChanged',
      },
      behaviors: [
        Polymer.BusListenerBehavior,
        Polymer.PermissionsBehavior,
        Polymer.LocalizationBehavior,
        Polymer.LoaderBehavior
      ],
      observers: [
        "_onMetadataChanged(metadata.*)",
      ],

      ready: function() {
        this.set("metadata", this._defaultMetadata());

        this.stylist = new Stylist();
        this.stylist.setUpMetadataEditorCustomizations();

        this.subscribeTo(
          'teacher-preview-configuration-changed',
          this._onPreviewChangesChanged.bind(this)
        );
      },

      getMetadata: function() {
        return this.metadata;
      },

      setMetadata: function(config) {
        this.set("metadata", config);
      },

      reset: function() {
        this.setMetadata(this._defaultMetadata());
        this.defaultToolbox = "";
        this.previewChanges = false;
      },

      isToolSelected: function(selectedToolbox, tool) {
        return selectedToolbox.features.includes(tool);
      },

      _computeSelectedToolbox: function(index) {
        return this.availableToolboxes[index];
      },

      // @faloi: no se puede poner un || en el binding, por eso creé esta función
      _either: function(x, y) {
        return x || y;
      },

      _onBoardVisibleEditionChanged: function () {
        const boardVisibleEdition = this.metadata.board.visible_edition;
        this.boardEditionOptionsDisabled = !boardVisibleEdition;
        this.setMetadata(_.merge({}, this.metadata, {
          board: {
            collapse_toolbox: false,
            user_permissions: {
              can_change_initial_board: boardVisibleEdition,
              can_view_size_section: boardVisibleEdition,
              can_view_attire_section: boardVisibleEdition,
              can_toggle_visibility: boardVisibleEdition
            }
          },
          attire: {
            user_permissions: {
              can_toggle_visibility: boardVisibleEdition
            }
          }
        }));
      },

      _onAttireSectionVisibleChanged: function () {
        const attireSectionVisible = this.metadata.board.user_permissions.can_view_attire_section;
        this.attireSectionDisabled = !attireSectionVisible;
        this.setMetadata(_.merge({}, this.metadata, {
          attire: {
            user_permissions: {
              can_toggle_visibility: attireSectionVisible
            }
          }
        }));
      },

      _onSelectedBlocksChanged: function({ detail: newBlocks }) {
        this.metadata.blocks = newBlocks;
        this._refreshPreviewIfEnabled(this.metadata);
      },

      _onMetadataChanged: function({ base }) {
        this.defaultToolbox = base.blocks && base.blocks.defaultToolbox;
        this.notifyPath('metadata.blocks');
        this._refreshPreviewIfEnabled(base);
      },

      _refreshPreviewIfEnabled(metadata) {
        if (this.previewChanges) {
          this._previewChanges(metadata);
        }
      },

      _onPreviewChangesChanged(previewChanges) {
        try {
          /* @faloi:
          Es redundante mantener este estado local,
          pero no sé cómo manejar estado global sin pasearlo por todos los componentes.
          */
          this.previewChanges = previewChanges;
          if (previewChanges) this._previewChanges(this.metadata);
          else this._resetPreview();
        } catch(e) {
          // Quién sabe para qué es este catch
        }
      },

      _previewChanges(metadata) {
        new MetadataLoader().readSecondaryOptions(this._context(), metadata);
      },

      _resetPreview() {
        new MetadataLoader().resetSecondaryOptions(this._context());
      },

      _defaultMetadata() {
        return {
          library: {
            visible: false
          },
          source: {
            visible: true,
            percentage: 0.6,
          },
          board: {
            visible_edition: true,
            collapse_toolbox: false,
            user_permissions: {
              can_change_initial_board: true,
              can_change_initial_board_source: true,
              can_edit_board: true,
              can_view_size_section: true,
              can_view_attire_section: true
            }
          },
          execution_speed: {
            user_permissions: {
              can_change_speed: true
            }
          },
          attire: {
            user_permissions: {
              can_toggle_visibility: true
            }
          },
          initialDescription: true,
          link: "",
          blocks: {
            visible: [],
            disabled: []
          }
        };
      }
    });
  </script>
</dom-module>


